<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='utf-8'>
        <title>
Python:建立一个IP代理池
|| 老钱</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<link rel='stylesheet' href='/static/css/normalize.css'>
		<link rel='stylesheet' href="/static/css/mono.css">
		<link rel='stylesheet' href='/static/css/bootstrap.css'>
		<link rel='stylesheet' media="screen and (min-width:1023px)"  href='/static/css/homepage.css'>
		<link rel='stylesheet' media="screen and (max-width:1023px)"  href='/static/icss/ihomepage.css'>
        

<link rel='stylesheet' media="screen and (min-width:1025px)"  href='/static/css/article.css'>


<link rel='stylesheet' media="screen and (max-width:1024px)"  href='/static/icss/iarticle.css'>


        
                 <script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-83291137-1', 'auto');
              ga('send', 'pageview');

        </script> 
        
        <script type="text/javascript" src="http://assets.vicomi.com/assets/widgets_static.js"></script>


<script>
(function() {
var v = document.createElement('script'); v.async = true;
v.src = "http://assets.vicomi.com/assets/widgets_static.js";
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(v, s);
})();
</script> 
        

    
    
    </head>
    
    <body>
        <div id="wrapper">
        <div id='main-page'>
           <div class="mask"></div>
            <header>
                <nav>
                    <div class="logo"><a href="/">老钱</a></div>
                    <button class="menu_trigger">☰</button>
                    <ul class="menu">
                        
                           
                        <li><a href='/'>文章</a></li> 
<!--
                        <li><a href='#'>归档</a></li> 
                        <li><a href='#'>关于</a></li>     
-->
                    </ul>
                    
                </nav>
                <div class="hr"></div>
            </header>
            <div class='content'>
                <div class="content_wrapper">
                    
    <div class="article_header">
        <h1 class="article_title"><a>Python:建立一个IP代理池</a></h1>                   
		<div class="article_info">2018-04-14 | 分类于:  <a class = 'tag' href="/tag/Python%E7%88%AC%E8%99%AB/">Python爬虫</a></div>
	</div>
	<article>
        
        

<p>生活中我们经常会用到一些代理服务器，尤其在做爬虫抓取对方网站数据的时候，很容易会被对方服务器封IP。通常我在抓取数据的时候会采用<strong>抓取数据-&gt;IP被封时触发代理抓取机制-&gt;使用代理继续抓取-&gt;代理耗尽重新抓取</strong>的机制，显得有些粗糙，而且在抓取代理的时候会阻塞，非常影响效率。痛定思痛，在开发Jalapeno的时候接触到事件驱动引擎，于是决定开发这个独立持续运转的代理池。</p>
<p>本节我会从事件驱动引擎开始演示并逐步实现抓取、存活验证等功能，最后完成使用Queue多线程多进程的并行及使用控制器通信。</p>
<!--More-->

<h2 id="_1">工具准备</h2>
<p>这次我们需要的工具有
- Python3.x （必备lol）
- Requests (熟悉urllib可以代替Requests，免去第三方库依赖)</p>
<p>先引入我们需要的工具</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span> <span class="c1">#线程模块</span>
<span class="kn">import</span> <span class="nn">os</span> <span class="c1">#系统调用，识别路径</span>
<span class="kn">import</span> <span class="nn">pickle</span> <span class="c1">#存储</span>
<span class="kn">import</span> <span class="nn">requests</span> <span class="kn">as</span> <span class="nn">req</span> <span class="c1">#Requests模块</span>
<span class="kn">import</span> <span class="nn">re</span> <span class="c1">#正则表达式</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="c1">#我们用time.sleep()休眠</span>
<span class="c1">#下面两个是队列模块，保护数据读写不混乱，跨进程通信。</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span><span class="p">,</span><span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Queue</span> <span class="k">as</span> <span class="n">QP</span><span class="p">,</span><span class="n">Process</span>
<span class="c1">#这里是个坑，在Mac下Multiprocessing 的Queue不能使用qsize， queue的Queue不能跨进程通信及pickle</span>
</pre></div>
</td></tr></table>

<h2 id="_2">事件驱动引擎</h2>
<p>先简单介绍一下事件驱动引擎的机制，事件驱动，顾名思义就是接收事件再处理事件的一个过程。流程如下</p>
<div class="codehilite"><pre><span></span>启动 -&gt; 引擎持续运转待命 -&gt;接收各类事件／信号（包括停止运行）-&gt;处理事件,如图
</pre></div>


<p><img alt="" src="/image/23/flow_min.png" /></p>
<p>代码结构如下：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">IP_proxy_pool</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">Start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">__Run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">__EventProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">eventName</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">__Stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</td></tr></table>

<p>接下来我们来看各个部分的代码及其原理</p>
<h3 id="init"><strong>init</strong></h3>
<p><strong>init</strong>包含了我们整个代理池的初始参数，其中一部分是引擎所需要的，另一部分是其他功能的参数。</p>
<p>代码：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ready</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">max_pages</span><span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">Pool_ready</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">max_pages</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">commander</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__workers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_available</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__active</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__worker_is_working</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__ready</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;proxylist.pkl&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span><span class="s1">&#39;Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.1.6) Gecko/20091201 Firefox/3.5.6&#39;</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">Stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Stop</span><span class="p">,</span>
        <span class="n">Crawl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crawler</span><span class="p">,</span>
        <span class="n">Status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Status</span><span class="p">,</span>
        <span class="n">Get</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_a_proxy</span><span class="p">,</span>
        <span class="n">Monitor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Monitor</span><span class="p">,</span>
        <span class="n">Verify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_IP</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<ul>
<li>self.setting:代理池默认设置。包含了爬虫最大访问页数和最低可用ip数量        </li>
<li>self.commander: 引擎组件。作为接收主进程命令的管道，在Start中初始化，并不需要在<strong>init</strong>中出现所以初始为None。后面会在多进程启动部分中讲解</li>
<li>self.output: 同上，将运行结果反馈给主进程</li>
<li>self.workers:引擎组件。包含了所有正在工作的子线程，通过dict的形式将任务名称和对应线程联系</li>
<li>self._Raw：从IP代理网站上解析出来的所有IP地址，未经过验证是否存活</li>
<li>self._available：存活可用的IP</li>
<li>self.<strong>active: 引擎组件。当self.</strong>active为True时，引擎保持运转。</li>
<li>self.__worker_is_working: 当值为True时，表示爬虫正在抓取IP地址。</li>
<li>self.ready: 监测控件。监测当前代理池中可用IP是否超过最低标准。如果低于标准，将启动IP抓取工作</li>
<li>self._cache_path: 存储／读取抓取结果到本地的路径</li>
<li>self.header: 爬虫请求网页的报头，与网络访问相关。会出现在Crawler和Verify中。</li>
<li>self.command: 包含了输入请求信号所对应的任务</li>
</ul>
<p>然后就开始我们的引擎组建工作</p>
<h3 id="start">Start()</h3>
<p>Start()相当于引擎的启动装置，建立通信管道，设置操作模式，最后进入运行。在多进程模式下，由于这是我们启动引擎执行的函数，所以我们使用“args= xxx"将通信和设置变量传入本函数中。</p>
<p>代码：</p>
<div class="codehilite"><pre><span></span>#！python
def Start(self,commander,output,Manual=True):
    self.__active = True
    self.commander,self.output = commander,output 
    self.read_cache()
    #for each in [&#39;Monitor&#39;]
    if Manual:
        self.__Run()
    else:
        for each in [&#39;Crawl&#39;,&#39;Monitor&#39;,&#39;Verify&#39;]:
            self.commander.put(each)
        self.__Run()
</pre></div>


<p>在Start中：</p>
<p>1.首先我们设置self.__active=True,表示引擎开始运转。
2.构建通信管道 self.commander,self.output，这两个变量是由主进程的控制器传入。
3.读取存档。没有存档会自行创建。
4.如果设置模式为Manual,则只维持运转，需要指令输入。如果不是，则自动启动爬虫，监测系统和IP筛选工作。</p>
<h3 id="__run">__Run()</h3>
<p>__Run()是引擎的运转核心，作用机制比较简单。当active指示为True时，维持运转，持续接收指示信号并交付处理。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__Run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">__active</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">eventname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commander</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__EventProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">[</span><span class="n">eventname</span><span class="p">],</span><span class="n">eventname</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="k">pass</span>
</pre></div>
</td></tr></table>

<p>先尝试从commander获取指示信号，如果为空，则except捕获异常跳过本轮循环。
如果顺利接受信号，则交付__EventProcess处理。</p>
<blockquote>
<p>注意：commander.get()方法中,我们设置timeout=1避免卡死，设置block来阻塞一个timeout的等待时常，避免程序高速运转浪费过多CPU资源。</p>
</blockquote>
<h3 id="__eventprocess">__EventProcess()</h3>
<p>__EventProcess()是引擎的事件处理调度模块，它在目前的工作中将任务分成两类并执行：直接执行和开启新线程并行。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__EventProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">eventName</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Event is Processing&quot;</span><span class="p">)</span>
    <span class="c1">#在主程序中直接运行</span>
    <span class="k">if</span> <span class="n">eventName</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Status&#39;</span><span class="p">,</span><span class="s1">&#39;Stop&#39;</span><span class="p">,</span><span class="s1">&#39;Get&#39;</span><span class="p">):</span>
        <span class="n">event</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span><span class="c1">#开线程运行</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__workers</span><span class="p">[</span><span class="n">eventName</span><span class="p">]</span><span class="o">=</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__workers</span><span class="p">[</span><span class="n">eventName</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<h3 id="__stop">__Stop()</h3>
<p>Stop()是在当我们的任务完成后，我们将要关闭引擎并自动存档的模块。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__Stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__active</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__workers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>      
        <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Saving your proxies . . .&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_cache</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>整个流程分成三步：</p>
<p>1.关闭active指示
2.等待workers中的所有子线程任务结束。
3.write_cache存档，方便下次读取</p>
<blockquote>
<p>这里需要注意的是关闭active指示需要在第一步。<strong>因为Thread不像Process那样可以调用terminate()强制中止</strong>，所以在相关子线程任务中我们保持了和引擎同步的方法，在任务执行完毕之前<strong>或者self.active=True</strong>的时候，都会保持运行。也就是说如果我们关掉active指示，我们就可以让所有子线程跳出循环自动退出。最后在第二步中用join方法等待任务结束。</p>
</blockquote>
<p>到这里我们的完整的食物驱动引擎架构基本完成，我们继续来构建功能性组件。</p>
<h2 id="_3">功能性组件</h2>
<p>功能性组件实现了我们代理池的核心功能，即抓取IP地址，实时监测，状态输出及读写功能。</p>
<h3 id="status">Status()状态输出</h3>
<p>状态输出是将我们的代理池的信息以字符串的形式放入output（输出管道），方便我们查看当前运行状态</p>
<p>代码：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">    Engine Active               {}</span>
<span class="s1">    IP Pool Ready               {}</span>
<span class="s1">    Crawler Working             {}</span>
<span class="s1">    Raw IP Pool size            {}</span>
<span class="s1">    Alive IP available          {}</span>

<span class="s1">    &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__active</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__ready</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__worker_is_working</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span><span class="o">.</span><span class="n">qsize</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">_available</span><span class="o">.</span><span class="n">qsize</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>示例：</p>
<div class="codehilite"><pre><span></span>In [34]: print(remote.send(&#39;Status&#39;))


    Engine Active               True
    IP Pool Ready               False
    Crawler Working             False
    Raw IP Pool size            399
    Alive IP available          0
</pre></div>


<h3 id="crawlerip">crawler():IP抓取爬虫</h3>
<p>看到这里终于看到我们的核心组件之一爬虫的真身了。这里我用西刺代理的高匿IP地址页面举例。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">crawler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__worker_is_working</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;tr class.*?&lt;td.*?&lt;td&gt;(.+?)&lt;/td.*?&lt;td&gt;(.+?)&lt;/td.*?&lt;/td.*?&lt;/td.*?&lt;td&gt;(.+?)&lt;/td.*?&lt;/tr&gt;&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;max_pages&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__active</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">page_source</span><span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://www.xicidaili.com/nn/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">headers</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span><span class="n">page_source</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">each</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__worker_is_working</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</td></tr></table>

<p>1.当爬虫开始运行时设置<strong>worker_is_working = True，表示爬虫结束运行。
2.接下来就是爬虫的抓取流程并将结果放入self._Raw中，爬虫可以参考我之前的相关文章。在这里要注意三点：
    - 使用requests(req)添加header的方法
    - time.sleep(60)设置爬取间隔，减少对方服务器访问压力。此时也可以和IP验证的时间同步
    - self._Raw使用的结构是队列（QUEUE）的形式，我们在这里用的是线程的Queue()而不是multiprocessing的Queue(),因为线程的Queue()自带线程锁，可以保护数据不错乱。并且可以使用qsize功能来获取队列长度（数量）
3.抓取完成。</strong>worker_is_working = False，退出。</p>
<h3 id="__monitor">__Monitor()</h3>
<p>Monitor()的运行机制如下，</p>
<div class="codehilite"><pre><span></span>def __Monitor(self):
    while self.__active:
        if self.__worker_is_working:
            pass
        elif self._available.qsize() &lt; self.settings[&#39;Pool_ready&#39;]:
            self.commander.put(&quot;Crawl&quot;)
        time.sleep(15)
</pre></div>


<ul>
<li>当引擎运行时，检测爬虫是否在工作。</li>
<li>如果没有在工作，检测代理池中的IP是否达到最低标准。</li>
<li>如果没有达到，启动爬虫，</li>
<li>休息15秒重新检测。</li>
</ul>
<h3 id="verify_ipip">verify_IP():IP存活验证</h3>
<p>事实上，并不是每一个从代理网站上抓取到的IP地址<strong>并不一定能用</strong>.所以在这里我们添加一下验证。原理很简单：从self._Raw里面拿出一个IP，挂上IP之后去访问一个网站（我这里就用百度了，不要怪我。。lol）,如果访问请求返回结果是200，则说明访问成功，该IP地址可以使用。</p>
<p>代码：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">verify_IP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">__active</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proxy_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#注意下面使用IP的格式 {&#39;HTTPS&#39;：&#39;183.159.80.92:18118&#39;}</span>
            <span class="n">req_proxy</span> <span class="o">=</span> <span class="p">{</span><span class="n">proxy_item</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="s1">&#39;{}:{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">proxy_item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">proxy_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;verifying {}:{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">proxy_item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">proxy_item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">attempt</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://www.baidu.com&#39;</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span><span class="n">proxies</span> <span class="o">=</span> <span class="n">req_proxy</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="c1">#注意这里使用IP的方式</span>
            <span class="k">if</span> <span class="n">attempt</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_available</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Raw pool is empty&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</pre></div>
</td></tr></table>

<h3 id="get_a_proxy-ip">get_a_proxy() 获得一个IP地址（输出）</h3>
<p>这一块的任务相对来说就简单许多，你只需要从可用的IP队列中获得一个并输出即可。（当可用IP队列为空时我用原始_Raw列队列充数这种事情我是不会说出来的hiahiahia，当然如果愿意用自己的爬虫来验证是否可用而不去检测有效的时候，会有一定的灵活操作空间）</p>
<div class="codehilite"><pre><span></span>def get_a_proxy(self):
    try:

        if self._available.qsize() &gt; 0:
            ip = self._available.get(block=True,timeout=1)
        else:
            ip = self._Raw.get(block=True,timeout=1)
        self.output.put(ip)

    except:
        self.output.put(&#39;Oops. Both pools Empty.&#39;)
</pre></div>


<h3 id="_4">存档读写</h3>
<p>抓取了很多很多好用的代理不想白白浪费吧，下次要用的时候不想等重头来过吧。存档读写功能，你值得拥有。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">read_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1">#检测是否文件已存在。如果没有就创建一个</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_cache</span><span class="p">()</span>
    <span class="c1">#读取内容</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_path</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">raw</span><span class="p">,</span><span class="n">available</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">each</span><span class="p">)</span> <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">]</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_available</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">each</span><span class="p">)</span> <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">available</span><span class="p">]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
<span class="c1">#存档            </span>
<span class="k">def</span> <span class="nf">write_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_path</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>
    <span class="n">available</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_available</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">raw</span><span class="p">,</span><span class="n">available</span><span class="p">],</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>比较令人郁闷的是我们的线程Queue()不能直接pickle存储，所以我们在这里先将其转换成列表.</p>
<p>好了，我们的IP代理池到这里就完结了？
NoNoNo,我们需要一个控制器来操作它。</p>
<h2 id="_5">使用方法</h2>
<p>我们来看一下我们在主进程是如何调用它的</p>
<h3 id="controller">Controller()：控制器</h3>
<p>前面讲到我们需要进行进程间的通信，所以我们使用self.commander和self.output来作为通信管道。我们将这两个管道和操作方法一起封装在一起，就是我们的控制器。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Controller</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commander</span> <span class="o">=</span> <span class="n">QP</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">QP</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commander</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Status&#39;</span><span class="p">,</span><span class="s1">&#39;Get&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>需要注意的是我们必须使用multiprocessing 封装的Queue才可以进行通信，</p>
<h3 id="_6">操作</h3>
<p>一个简单的操作演示，在解释器上跑跑看</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">#先创建一个代理池</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">39</span><span class="p">]:</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">IP_proxy_pool</span><span class="p">()</span>
<span class="c1">#创建控制器</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">40</span><span class="p">]:</span> <span class="n">remote</span> <span class="o">=</span> <span class="n">Controller</span><span class="p">()</span>
<span class="c1">#创建一个新进程来使用代理池引擎</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">41</span><span class="p">]:</span> <span class="n">pool_process</span><span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">Start</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">remote</span><span class="o">.</span><span class="n">commander</span><span class="p">,</span><span class="n">remote</span><span class="o">.</span><span class="n">output</span><span class="p">,))</span>
<span class="c1">#启动引擎,这里的start不是引擎的Start，是进程的启动操作，通过start()调用Start()</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">42</span><span class="p">]:</span><span class="n">pool_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="c1">#最后可以通过Controller的send()方法操作</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">43</span><span class="p">]:</span> <span class="n">remote</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;Get&#39;</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">43</span><span class="p">]:</span> <span class="p">(</span><span class="s1">&#39;49.81.34.87&#39;</span><span class="p">,</span> <span class="s1">&#39;46491&#39;</span><span class="p">,</span> <span class="s1">&#39;HTTPS&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>好啦，一个IP代理池到这里就被我们构建出来了。可以放在代码里自动运行也可以在解释器里面手工操作获得IP地址。以后挂代理看视频抓数据就用它了hiahiahia.</p>
<p>哦对了，最后留几个作业lol:想想看如何完善里面的监测和报错机制，如何抓取其他网站的IP，如何避免抓取到重复的IP</p>
<p>先就这么多了，Bye~</p>
<h2 id="_7">完整代码</h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">requests</span> <span class="kn">as</span> <span class="nn">req</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span><span class="p">,</span><span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Queue</span> <span class="k">as</span> <span class="n">QP</span><span class="p">,</span><span class="n">Process</span>
<span class="c1">#这里是个坑，Multiprocessing 的Queue不能使用qsize， queue的Queue不能跨进程通信及pickle</span>


<span class="k">class</span> <span class="nc">IP_proxy_pool</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ready</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">max_pages</span><span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">Pool_ready</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">max_pages</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commander</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__workers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__worker_is_working</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ready</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;proxylist.pkl&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span><span class="s1">&#39;Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.1.6) Gecko/20091201 Firefox/3.5.6&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">Stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Stop</span><span class="p">,</span>
            <span class="n">Crawl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crawler</span><span class="p">,</span>
            <span class="n">Status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Status</span><span class="p">,</span>
            <span class="n">Get</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_a_proxy</span><span class="p">,</span>
            <span class="n">Monitor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Monitor</span><span class="p">,</span>
            <span class="n">Verify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_IP</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commander</span><span class="p">,</span><span class="n">output</span><span class="p">,</span><span class="n">Manual</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__active</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commander</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">commander</span><span class="p">,</span><span class="n">output</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">read_cache</span><span class="p">()</span>
        <span class="c1">#for each in [&#39;Monitor&#39;]</span>
        <span class="k">if</span> <span class="n">Manual</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__Run</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Crawl&#39;</span><span class="p">,</span><span class="s1">&#39;Monitor&#39;</span><span class="p">,</span><span class="s1">&#39;Verify&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commander</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">each</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__Run</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__Run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">__active</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">eventname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commander</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1">#Need Check event</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Receive the command {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eventname</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__EventProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">[</span><span class="n">eventname</span><span class="p">],</span><span class="n">eventname</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__EventProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">eventName</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Event is Processing&quot;</span><span class="p">)</span>
        <span class="c1">#在主程序中直接运行</span>
        <span class="k">if</span> <span class="n">eventName</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Status&#39;</span><span class="p">,</span><span class="s1">&#39;Stop&#39;</span><span class="p">,</span><span class="s1">&#39;Get&#39;</span><span class="p">):</span>
            <span class="n">event</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span><span class="c1">#开线程运行</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__workers</span><span class="p">[</span><span class="n">eventName</span><span class="p">]</span><span class="o">=</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__workers</span><span class="p">[</span><span class="n">eventName</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">__Stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__workers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>      
            <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Saving your proxies . . .&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_cache</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">Status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;You reached level Status&quot;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">        Engine Active               {}</span>
<span class="s1">        IP Pool Ready               {}</span>
<span class="s1">        Crawler Working             {}</span>
<span class="s1">        Raw IP Pool size            {}</span>
<span class="s1">        Alive IP available          {}</span>

<span class="s1">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__active</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__ready</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__worker_is_working</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span><span class="o">.</span><span class="n">qsize</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">_available</span><span class="o">.</span><span class="n">qsize</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">crawler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__worker_is_working</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;tr class.*?&lt;td.*?&lt;td&gt;(.+?)&lt;/td.*?&lt;td&gt;(.+?)&lt;/td.*?&lt;/td.*?&lt;/td.*?&lt;td&gt;(.+?)&lt;/td.*?&lt;/tr&gt;&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;max_pages&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__active</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">page_source</span><span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://www.xicidaili.com/nn/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">headers</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span><span class="n">page_source</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">each</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__worker_is_working</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__Monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">__active</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__worker_is_working</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Pool_ready&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commander</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;Crawl&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">verify_IP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">__active</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">proxy_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">req_proxy</span> <span class="o">=</span> <span class="p">{</span><span class="n">proxy_item</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="s1">&#39;{}:{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">proxy_item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">proxy_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;verifying {}:{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">proxy_item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">proxy_item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">attempt</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://www.baidu.com&#39;</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span><span class="n">proxies</span> <span class="o">=</span> <span class="n">req_proxy</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attempt</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_available</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Raw pool is empty&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_a_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;Oops. Both pools Empty.&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">read_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_cache</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_path</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                <span class="n">raw</span><span class="p">,</span><span class="n">available</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">each</span><span class="p">)</span> <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">]</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_available</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">each</span><span class="p">)</span> <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">available</span><span class="p">]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">write_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_path</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Raw</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>
        <span class="n">available</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_available</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">raw</span><span class="p">,</span><span class="n">available</span><span class="p">],</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Controller</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commander</span> <span class="o">=</span> <span class="n">QP</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">QP</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commander</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Status&#39;</span><span class="p">,</span><span class="s1">&#39;Get&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<h2 id="reference">Reference</h2>
<ul>
<li><a href="http://www.vnpy.org/basic-tutorial-4.html">事件驱动引擎原理和使用: vn.py</a></li>
<li><a href="http://python.jobbole.com/86994/">Python爬虫代理池结构</a></li>
<li><a href="http://chenghaoqian.com">ChenghaoQian.com: （我自己）</a></li>
</ul>
		
	</article>
	<div id="copyright"><a href="/copyright">&copy;著作权归作者所有</a></div>
	<hr>
    <div id="vc-main" data-access-token="11c8370248773a268137e6fb158a3884"></div>
    
    <div id="vc-feelback-main" data-access-token="bd6f14702ab835406654dbd001f2c721" data-display-type="4" ></div> 

                </div>
    
            </div>
            
            <footer>
                <ul class="share-group">
                    <li><a href="#">Jalapeno急速运转中</a></li>
                    <!--<li><a href="#">item</a></li>
                    <li><a href="#">item</a></li>
                    <li><a href="#">item</a></li>
                    <li><a href="#">item</a></li>--> 
                </ul>   
                <div class="copyright">
                    &copy ChenghaoQ;
                </div>

            </footer>
            
            
            <div class="back-to-top">
            	<span class="glyphicon glyphicon-chevron-up"></span>
            </div>
            <div id="closeBar">
                <span class="glyphicon glyphicon-remove"></span>
            </div>
        
        </div>
          
            
        
        
        
        
        
        
        <div id="sidebar">
            <div id="sidebar-menu">

               	<div id="home"><a href="/"><span class="glyphicon glyphicon-home"></span></a></div>
               	<ul>
               	    
<li id="catalog" class="item">
    <span class="glyphicon glyphicon-list-alt"></span>

</li>


               	    <li id="site-view" class="item">
                        <span class="glyphicon glyphicon-align-center"></span>
                    
                    </li>
               	 </ul>
                
            </div>
            <div id="sidebar-content" >
                

<div class="nav-content" id="catalog-content">
    <div class="nav-con-close">
        <span class='glyphicon glyphicon-chevron-right'></span>
    </div>
    <div class="nav-con-title">目录</div>
    <div class="inner-content">
        <div class="toc">
<ul>
<li><a href="#_1">工具准备</a></li>
<li><a href="#_2">事件驱动引擎</a><ul>
<li><a href="#init">init</a></li>
<li><a href="#start">Start()</a></li>
<li><a href="#__run">__Run()</a></li>
<li><a href="#__eventprocess">__EventProcess()</a></li>
<li><a href="#__stop">__Stop()</a></li>
</ul>
</li>
<li><a href="#_3">功能性组件</a><ul>
<li><a href="#status">Status()状态输出</a></li>
<li><a href="#crawlerip">crawler():IP抓取爬虫</a></li>
<li><a href="#__monitor">__Monitor()</a></li>
<li><a href="#verify_ipip">verify_IP():IP存活验证</a></li>
<li><a href="#get_a_proxy-ip">get_a_proxy() 获得一个IP地址（输出）</a></li>
<li><a href="#_4">存档读写</a></li>
</ul>
</li>
<li><a href="#_5">使用方法</a><ul>
<li><a href="#controller">Controller()：控制器</a></li>
<li><a href="#_6">操作</a></li>
</ul>
</li>
<li><a href="#_7">完整代码</a></li>
<li><a href="#reference">Reference</a></li>
</ul>
</div>

    </div>
</div>

                    <div class="nav-content" id="site-view-content">
                    <div class="nav-con-close">
                        <span class='glyphicon glyphicon-chevron-right'></span>
                    </div>
                
                    <div class="inner-content">
                        <div class="selfie"><img src='/image/theme/Selfie.JPG'</div>
                        <div class="site-view-info">
                         
                            <p class="motto">你总有一个坚持下去的理由</p>
                
                            <h3 class="myself">老钱</h3>
                            
                            <ul class="posts-info">
                            </ul>
                            <div class="extern-links">
                               <ul>
                                   <li><a href="https://github.com/ChenghaoQ">Github</a></li>
                               <li><a>Wechat</a></li>            
                               </ul>
     
                            </div>
                
                    </div>
                </div>
            </div>
            </div>
        </div>
            
        </div>
		<script src="/static/js/jquery.js"></script>
        <!--<script src="/static/js/home.js"></script>
        <script src="/static/ijs/ihome.js"></script>-->
        <script type = "text/javascript">
        $(document).ready(function(){
            if($(window).width()>1024){
                temp = 'desktop';
                $.getScript( "/static/js/home.js" )
            }
            else
            {
                temp = 'mobile';
                $.getScript( "/static/ijs/ihome.js" )
            }
            console.log('reload');
            function refresher(){
                if($(window).width()>1024)
                    var status = 'desktop';
                else
                    var status = 'mobile';
                if (status!= temp)
                {
                    location=location;//refresh page
                    
                    temp = status;
                    
                }
                console.log(temp)
            };

            $(window).resize(refresher);
        });
        </script>

        
        

<!--         
        <script type="text/javascript" src="http://assets.vicomi.com/assets/widgets_static.js"></script>


        <script>
        (function() {
        var v = document.createElement('script'); v.async = true;
        v.src = "http://assets.vicomi.com/assets/widgets_static.js";
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(v, s);
        })();
        </script>  -->


        <!-- Carnival comments -->
        <!-- <script src="https://carnivalapp.io/sites/559/init.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", Carnival.init);
        </script> -->



    </body>





</html>